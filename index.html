<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockBois</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #ff9a56 0%, #ff6b35 100%);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 80px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .stock-overview {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .stock-level {
            text-align: center;
            margin-bottom: 20px;
        }

        .stock-number {
            font-size: 48px;
            font-weight: bold;
            color: #ff6b35;
        }

        .stock-number.low {
            color: #ef4444;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .stock-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .alert {
            background: #fee2e2;
            border: 2px solid #ef4444;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            color: #991b1b;
            font-weight: 600;
            text-align: center;
            display: none;
        }

        .alert.show {
            display: block;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab.active {
            background: white;
            color: #ff6b35;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            transition: border 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #ff6b35;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #ff9a56 0%, #ff6b35 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .history-item {
            border-bottom: 1px solid #e5e7eb;
            padding: 15px 0;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-type {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .history-type.entry {
            background: #d1fae5;
            color: #065f46;
        }

        .history-type.exit {
            background: #fee2e2;
            color: #991b1b;
        }

        .history-details {
            font-size: 14px;
            color: #666;
            line-height: 1.6;
        }

        .history-date {
            font-weight: 600;
            color: #333;
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .stat-box {
            background: #f9fafb;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #ff6b35;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 60px;
            height: 60px;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        .days-remaining {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-top: 20px;
        }

        .days-remaining.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .days-remaining.critical {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .days-number {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .days-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .consumption-rate {
            font-size: 12px;
            margin-top: 10px;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü™µ StockBois</h1>
            <div id="connectionStatus" style="font-size: 13px; margin-top: 5px;">üü° Connexion...</div>
        </div>

        <div class="stock-overview">
            <div class="alert" id="lowStockAlert">
                ‚ö†Ô∏è Stock faible ! Il reste moins de 3 st√®res
            </div>
            
            <div class="stock-level">
                <div class="stock-number" id="stockNumber">0</div>
                <div class="stock-label">st√®res restants</div>
            </div>

            <div class="stats">
                <div class="stat-box">
                    <div class="stat-value" id="totalEntries">0</div>
                    <div class="stat-label">Entr√©es totales</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="lastExitDuration">-</div>
                    <div class="stat-label">Derni√®re sortie</div>
                </div>
            </div>

            <div class="days-remaining" id="daysRemaining" style="display: none;">
                <div class="days-number" id="daysNumber">0</div>
                <div class="days-label">jours de chauffage restants</div>
                <div class="consumption-rate" id="consumptionRate"></div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('entry', event)">‚ûï Entr√©e</button>
            <button class="tab" onclick="switchTab('exit', event)">‚ûñ Sortie</button>
            <button class="tab" onclick="switchTab('history', event)">üìã Historique</button>
            <button class="tab" onclick="switchTab('settings', event)">‚öôÔ∏è R√©glages</button>
        </div>

        <!-- Entr√©e -->
        <div id="entry" class="tab-content active">
            <div class="card">
                <h2 style="margin-bottom: 20px; color: #333;">Nouvelle entr√©e de bois</h2>
                <form onsubmit="addEntry(event)">
                    <div class="form-group">
                        <label>Entreprise</label>
                        <input type="text" id="entryCompany" required placeholder="Nom de l'entreprise">
                    </div>
                    <div class="form-group">
                        <label>T√©l√©phone fixe (optionnel)</label>
                        <input type="tel" id="entryPhoneFixe" placeholder="Ex: 05 46 33 15 70">
                    </div>
                    <div class="form-group">
                        <label>T√©l√©phone portable (optionnel)</label>
                        <input type="tel" id="entryPhoneMobile" placeholder="Ex: 06 50 27 40 82">
                    </div>
                    <div class="form-group">
                        <label>Adresse (optionnelle)</label>
                        <textarea id="entryAddress" rows="2" placeholder="Adresse compl√®te" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 16px; font-family: inherit; resize: vertical;"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="entryDate" required>
                    </div>
                    <div class="form-group">
                        <label>Quantit√© (st√®res)</label>
                        <input type="number" id="entryQuantity" step="0.1" required placeholder="Ex: 5">
                    </div>
                    <div class="form-group">
                        <label>Prix par st√®re (‚Ç¨)</label>
                        <input type="number" id="entryPrice" step="0.01" required placeholder="Ex: 85.00">
                    </div>
                    <div class="form-group">
                        <label>Notes / Commentaires (optionnel)</label>
                        <textarea id="entryNotes" rows="3" placeholder="Ex: 7.2 brouettes par big-bag, livraison par camion, caution 15‚Ç¨..." style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 16px; font-family: inherit; resize: vertical;"></textarea>
                    </div>
                    <button type="submit" class="btn">Enregistrer l'entr√©e</button>
                </form>
            </div>
        </div>

        <!-- Sortie -->
        <div id="exit" class="tab-content">
            <div class="card">
                <h2 style="margin-bottom: 20px; color: #333;">Nouvelle sortie de bois</h2>
                <form onsubmit="addExit(event)">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="exitDate" required>
                    </div>
                    <div class="form-group">
                        <label>Nombre de brouettes</label>
                        <input type="number" id="exitWheelbarrows" step="0.25" required placeholder="Ex: 0.75, 1, 10">
                    </div>
                    <div class="form-group">
                        <label style="color: #666; font-weight: normal; font-size: 13px;">
                            √âquivaut √† environ <span id="exitEquivalent">0</span> st√®res
                        </label>
                    </div>
                    <button type="submit" class="btn">Enregistrer la sortie</button>
                </form>
            </div>
        </div>

        <!-- Historique -->
        <div id="history" class="tab-content">
            <div class="card">
                <h2 style="margin-bottom: 20px; color: #333;">Historique des mouvements</h2>
                
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="filter-btn active" onclick="filterHistory('all')" id="filterAll" style="flex: 1; padding: 10px; background: #ff6b35; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Tout</button>
                    <button class="filter-btn" onclick="filterHistory('entries')" id="filterEntries" style="flex: 1; padding: 10px; background: #e5e7eb; color: #333; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Entr√©es</button>
                    <button class="filter-btn" onclick="filterHistory('exits')" id="filterExits" style="flex: 1; padding: 10px; background: #e5e7eb; color: #333; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Sorties</button>
                </div>
                
                <div id="historyList"></div>
            </div>
        </div>

        <!-- R√©glages -->
        <div id="settings" class="tab-content">
            <div class="card">
                <h2 style="margin-bottom: 20px; color: #333;">R√©glages</h2>
                <div class="form-group">
                    <label>Nombre de brouettes par st√®re</label>
                    <input type="number" id="wheelbarrowsPerStere" step="1" value="25" onchange="saveSettings()">
                    <p style="font-size: 12px; color: #666; margin-top: 8px;">
                        Cette valeur permet d'estimer le stock restant en fonction du nombre de brouettes utilis√©es
                    </p>
                </div>
                <div class="form-group">
                    <label>Seuil d'alerte (st√®res)</label>
                    <input type="number" id="alertThreshold" step="0.5" value="3" onchange="saveSettings()">
                    <p style="font-size: 12px; color: #666; margin-top: 8px;">
                        Vous serez alert√© quand le stock descend en dessous de cette valeur
                    </p>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="trackDays" onchange="saveSettings()" style="width: auto; margin-right: 8px;">
                        Calculer les jours restants automatiquement
                    </label>
                    <p style="font-size: 12px; color: #666; margin-top: 8px;">
                        Estime combien de jours de chauffage il vous reste bas√© sur votre consommation moyenne
                    </p>
                </div>
                <button onclick="exportData()" class="btn" style="margin-bottom: 10px;">üì• Exporter les donn√©es</button>
                <button onclick="importData()" class="btn" style="background: linear-gradient(135deg, #f59e0b 0%, #dc2626 100%); margin-bottom: 10px;">üì§ Importer des donn√©es</button>
                <button onclick="syncToFirebase()" class="btn" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);">‚òÅÔ∏è Synchroniser vers le cloud</button>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImport(event)">
            </div>
        </div>
    </div>

    <!-- Firebase SDK (compatible CDN) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBLPFOqtNsY5coXS_z49Lhj0p94nAzXqEw",
            authDomain: "stockbois-e2c21.firebaseapp.com",
            projectId: "stockbois-e2c21",
            storageBucket: "stockbois-e2c21.firebasestorage.app",
            messagingSenderId: "365832880082",
            appId: "1:365832880082:web:052fb2461b37078863920b"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const docRef = db.collection("stockbois").doc("data");

        // Initialisation
        let data = {
            entries: [],
            exits: [],
            settings: {
                wheelbarrowsPerStere: 25,
                alertThreshold: 3,
                trackDays: true
            }
        };
        
        let currentFilter = 'all';

        // Indicateur connexion
        let isOnline = navigator.onLine;
        
        function updateConnectionStatus(online) {
            isOnline = online;
            const el = document.getElementById('connectionStatus');
            if (online) {
                el.innerHTML = 'üü¢ Synchronis√©';
                el.style.color = '#22c55e';
            } else {
                el.innerHTML = 'üî¥ Hors ligne (sauvegarde locale)';
                el.style.color = '#ef4444';
            }
        }
        window.addEventListener('online', () => updateConnectionStatus(true));
        window.addEventListener('offline', () => updateConnectionStatus(false));

        // Charger les donn√©es au d√©marrage
        async function loadData() {
            const saved = localStorage.getItem('woodStockData');
            if (saved) {
                data = JSON.parse(saved);
                if (data.settings.trackDays === undefined) data.settings.trackDays = true;
                initUI();
            } else {
                initUI();
            }

            if (typeof firebase === 'undefined') {
                updateConnectionStatus(false);
                return;
            }

            const timeoutId = setTimeout(() => {
                console.log('Firebase timeout');
                updateConnectionStatus(false);
            }, 5000);

            try {
                docRef.onSnapshot((snapshot) => {
                    clearTimeout(timeoutId);
                    if (snapshot.exists) {
                        const firebaseData = snapshot.data();
                        const localTs = data.entries.length > 0 ? 
                            Math.max(...data.entries.map(e => e.timestamp || 0)) : 0;
                        const fbTs = firebaseData.entries && firebaseData.entries.length > 0 ?
                            Math.max(...firebaseData.entries.map(e => e.timestamp || 0)) : 0;
                        
                        if (fbTs >= localTs) {
                            data = firebaseData;
                            if (data.settings.trackDays === undefined) data.settings.trackDays = true;
                            localStorage.setItem('woodStockData', JSON.stringify(data));
                            initUI();
                        }
                        updateConnectionStatus(true);
                    } else {
                        if (saved) {
                            docRef.set(JSON.parse(JSON.stringify(data)));
                        }
                        updateConnectionStatus(true);
                    }
                }, (error) => {
                    clearTimeout(timeoutId);
                    console.log('Firebase error:', error);
                    updateConnectionStatus(false);
                });
            } catch(e) {
                clearTimeout(timeoutId);
                console.log('Firebase catch:', e);
                updateConnectionStatus(false);
            }
        }

        function initUI() {
            document.getElementById('wheelbarrowsPerStere').value = data.settings.wheelbarrowsPerStere;
            document.getElementById('alertThreshold').value = data.settings.alertThreshold;
            document.getElementById('trackDays').checked = data.settings.trackDays;
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('entryDate').value = today;
            document.getElementById('exitDate').value = today;
            updateDisplay();
        }

        async function saveData() {
            localStorage.setItem('woodStockData', JSON.stringify(data));
            if (isOnline) {
                try {
                    await docRef.set(JSON.parse(JSON.stringify(data)));
                    updateConnectionStatus(true);
                } catch(e) {
                    updateConnectionStatus(false);
                }
            }
        }

        function calculateStock() {
            const totalEntries = data.entries.reduce((sum, e) => sum + parseFloat(e.quantity), 0);
            const totalWheelbarrows = data.exits.reduce((sum, e) => sum + parseFloat(e.wheelbarrows), 0);
            const steresUsed = totalWheelbarrows / data.settings.wheelbarrowsPerStere;
            return Math.max(0, totalEntries - steresUsed);
        }

        function calculateDaysRemaining() {
            if (!data.settings.trackDays || data.exits.length < 2) {
                return null;
            }

            const sortedExits = [...data.exits].sort((a, b) => 
                new Date(a.date).getTime() - new Date(b.date).getTime()
            );

            const firstDate = new Date(sortedExits[0].date);
            const lastDate = new Date(sortedExits[sortedExits.length - 1].date);
            const daysDiff = Math.max(1, (lastDate - firstDate) / (1000 * 60 * 60 * 24));

            const totalWheelbarrows = data.exits.reduce((sum, e) => sum + parseInt(e.wheelbarrows), 0);
            const wheelbarrowsPerDay = totalWheelbarrows / daysDiff;

            const stock = calculateStock();
            const wheelbarrowsRemaining = stock * data.settings.wheelbarrowsPerStere;

            const daysRemaining = wheelbarrowsPerDay > 0 ? Math.round(wheelbarrowsRemaining / wheelbarrowsPerDay) : 0;

            return {
                days: daysRemaining,
                wheelbarrowsPerDay: wheelbarrowsPerDay.toFixed(2)
            };
        }

        function updateDisplay() {
            const stock = calculateStock();
            const stockElement = document.getElementById('stockNumber');
            const alertElement = document.getElementById('lowStockAlert');
            
            stockElement.textContent = stock.toFixed(1);
            
            if (stock <= data.settings.alertThreshold) {
                stockElement.classList.add('low');
                alertElement.classList.add('show');
            } else {
                stockElement.classList.remove('low');
                alertElement.classList.remove('show');
            }
            
            document.getElementById('totalEntries').textContent = data.entries.reduce((sum, e) => sum + parseFloat(e.quantity), 0).toFixed(1);
            
            const lastExitElement = document.getElementById('lastExitDuration');
            if (data.exits.length > 0) {
                const sortedExits = [...data.exits].sort((a, b) => new Date(b.date) - new Date(a.date));
                const lastExit = sortedExits[0];
                const lastExitDate = new Date(lastExit.date);
                const today = new Date();
                const diffTime = Math.abs(today - lastExitDate);
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays === 0) {
                    lastExitElement.textContent = "Aujourd'hui";
                } else if (diffDays === 1) {
                    lastExitElement.textContent = "Hier";
                } else if (diffDays < 7) {
                    lastExitElement.textContent = `Il y a ${diffDays}j`;
                } else if (diffDays < 30) {
                    const weeks = Math.floor(diffDays / 7);
                    lastExitElement.textContent = `Il y a ${weeks} sem.`;
                } else if (diffDays < 365) {
                    const months = Math.floor(diffDays / 30);
                    lastExitElement.textContent = `Il y a ${months} mois`;
                } else {
                    const years = Math.floor(diffDays / 365);
                    lastExitElement.textContent = `Il y a ${years} an${years > 1 ? 's' : ''}`;
                }
            } else {
                lastExitElement.textContent = "Aucune";
            }
            
            const daysInfo = calculateDaysRemaining();
            const daysElement = document.getElementById('daysRemaining');
            
            if (daysInfo && daysInfo.days > 0) {
                daysElement.style.display = 'block';
                document.getElementById('daysNumber').textContent = daysInfo.days;
                document.getElementById('consumptionRate').textContent = 
                    `Consommation moyenne : ${daysInfo.wheelbarrowsPerDay} brouettes/jour`;
                
                daysElement.classList.remove('warning', 'critical');
                if (daysInfo.days <= 7) {
                    daysElement.classList.add('critical');
                } else if (daysInfo.days <= 30) {
                    daysElement.classList.add('warning');
                }
            } else {
                daysElement.style.display = 'none';
            }
            
            updateHistory();
            updateExitEquivalent();
        }

        function addEntry(event) {
            event.preventDefault();
            
            const entry = {
                type: 'entry',
                company: document.getElementById('entryCompany').value,
                phoneFixe: document.getElementById('entryPhoneFixe').value || null,
                phoneMobile: document.getElementById('entryPhoneMobile').value || null,
                address: document.getElementById('entryAddress').value || null,
                date: document.getElementById('entryDate').value,
                quantity: parseFloat(document.getElementById('entryQuantity').value),
                price: parseFloat(document.getElementById('entryPrice').value),
                notes: document.getElementById('entryNotes').value || null,
                timestamp: Date.now()
            };
            
            data.entries.push(entry);
            saveData();
            updateDisplay();
            
            event.target.reset();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('entryDate').value = today;
            
            alert('‚úÖ Entr√©e enregistr√©e !');
        }

        function addExit(event) {
            event.preventDefault();
            
            const exit = {
                type: 'exit',
                date: document.getElementById('exitDate').value,
                wheelbarrows: parseFloat(document.getElementById('exitWheelbarrows').value),
                timestamp: Date.now()
            };
            
            data.exits.push(exit);
            saveData();
            updateDisplay();
            
            event.target.reset();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('exitDate').value = today;
            
            alert('‚úÖ Sortie enregistr√©e !');
        }

        function updateExitEquivalent() {
            const wheelbarrows = document.getElementById('exitWheelbarrows').value || 0;
            const steres = (wheelbarrows / data.settings.wheelbarrowsPerStere).toFixed(2);
            document.getElementById('exitEquivalent').textContent = steres;
        }

        document.getElementById('exitWheelbarrows').addEventListener('input', updateExitEquivalent);

        function updateHistory() {
            const historyList = document.getElementById('historyList');
            
            let allMovements = [
                ...data.entries.map(e => ({...e, type: 'entry'})),
                ...data.exits.map(e => ({...e, type: 'exit'}))
            ].sort((a, b) => b.timestamp - a.timestamp);
            
            if (currentFilter === 'entries') {
                allMovements = allMovements.filter(m => m.type === 'entry');
            } else if (currentFilter === 'exits') {
                allMovements = allMovements.filter(m => m.type === 'exit');
            }
            
            if (allMovements.length === 0) {
                historyList.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <p>Aucun mouvement ${currentFilter === 'entries' ? "d'entr√©e" : currentFilter === 'exits' ? 'de sortie' : ''} enregistr√©</p>
                    </div>
                `;
                return;
            }
            
            historyList.innerHTML = allMovements.map(m => {
                if (m.type === 'entry') {
                    let contactInfo = '';
                    if (m.phoneFixe || m.phoneMobile || m.phone || m.address) {
                        contactInfo = '<div style="margin-top: 8px; font-size: 13px; color: #555; background: #f9fafb; padding: 8px; border-radius: 6px;">';
                        if (m.phoneFixe) {
                            contactInfo += `<div style="margin-bottom: 4px;"><a href="tel:${m.phoneFixe}" style="color: #ff6b35; text-decoration: none; font-weight: 600;">‚òéÔ∏è Fixe: ${m.phoneFixe}</a></div>`;
                        }
                        if (m.phoneMobile) {
                            contactInfo += `<div style="margin-bottom: 4px;"><a href="tel:${m.phoneMobile}" style="color: #ff6b35; text-decoration: none; font-weight: 600;">üì± Mobile: ${m.phoneMobile}</a></div>`;
                        }
                        if (m.phone && !m.phoneFixe && !m.phoneMobile) {
                            contactInfo += `<div style="margin-bottom: 4px;"><a href="tel:${m.phone}" style="color: #ff6b35; text-decoration: none; font-weight: 600;">üìû ${m.phone}</a></div>`;
                        }
                        if (m.address) {
                            contactInfo += `<div style="font-size: 12px; color: #666;">üìç ${m.address}</div>`;
                        }
                        contactInfo += '</div>';
                    }
                    
                    let notesInfo = '';
                    if (m.notes) {
                        notesInfo = `<div style="margin-top: 8px; padding: 8px; background: #fff4e6; border-left: 3px solid #ff9a56; border-radius: 4px; font-size: 13px; color: #333;">
                            <div style="font-weight: 600; color: #ff6b35; margin-bottom: 4px;">üìù Notes :</div>
                            <div style="white-space: pre-wrap;">${m.notes}</div>
                        </div>`;
                    }
                    
                    return `
                        <div class="history-item">
                            <span class="history-type entry">ENTR√âE</span>
                            <div class="history-details">
                                <div class="history-date">${formatDate(m.date)}</div>
                                <div><strong>${m.company}</strong></div>
                                ${contactInfo}
                                <div>${m.quantity} st√®res √ó ${m.price}‚Ç¨ = ${(m.quantity * m.price).toFixed(2)}‚Ç¨</div>
                                ${notesInfo}
                            </div>
                        </div>
                    `;
                } else {
                    const steres = (m.wheelbarrows / data.settings.wheelbarrowsPerStere).toFixed(2);
                    return `
                        <div class="history-item">
                            <span class="history-type exit">SORTIE</span>
                            <div class="history-details">
                                <div class="history-date">${formatDate(m.date)}</div>
                                <div>${m.wheelbarrows} brouettes (‚âà ${steres} st√®res)</div>
                            </div>
                        </div>
                    `;
                }
            }).join('');
        }
        
        function filterHistory(type) {
            currentFilter = type;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.style.background = '#e5e7eb';
                btn.style.color = '#333';
            });
            const activeBtn = type === 'all' ? 'filterAll' : type === 'entries' ? 'filterEntries' : 'filterExits';
            const btn = document.getElementById(activeBtn);
            btn.style.background = '#ff6b35';
            btn.style.color = 'white';
            updateHistory();
        }

        function formatDate(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('fr-FR', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        function saveSettings() {
            data.settings.wheelbarrowsPerStere = parseInt(document.getElementById('wheelbarrowsPerStere').value);
            data.settings.alertThreshold = parseFloat(document.getElementById('alertThreshold').value);
            data.settings.trackDays = document.getElementById('trackDays').checked;
            saveData();
            updateDisplay();
        }

        // Changer d'onglet ‚Äî event pass√© en param√®tre pour corriger le bug
        function switchTab(tabName, event) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        function exportData() {
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'gestion-bois-backup-' + new Date().toISOString().split('T')[0] + '.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            document.getElementById('importFile').click();
        }

        async function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    const choice = confirm(
                        '‚ö†Ô∏è Import de donn√©es\n\nCliquez OK pour REMPLACER toutes les donn√©es.\nCliquez Annuler pour FUSIONNER avec les donn√©es existantes.'
                    );
                    
                    if (choice) {
                        data = importedData;
                    } else {
                        const existingTimestamps = new Set([
                            ...data.entries.map(e => e.timestamp),
                            ...data.exits.map(e => e.timestamp)
                        ]);
                        const newEntries = importedData.entries.filter(e => !existingTimestamps.has(e.timestamp));
                        const newExits = importedData.exits.filter(e => !existingTimestamps.has(e.timestamp));
                        data.entries = [...data.entries, ...newEntries].sort((a,b) => a.timestamp - b.timestamp);
                        data.exits = [...data.exits, ...newExits].sort((a,b) => a.timestamp - b.timestamp);
                    }
                    
                    await saveData();
                    updateDisplay();
                    alert('‚úÖ Donn√©es import√©es et synchronis√©es !');
                } catch (error) {
                    alert("‚ùå Erreur lors de l'import. Fichier invalide.");
                }
            };
            reader.readAsText(file);
        }

        async function syncToFirebase() {
            if (!isOnline) {
                alert('‚ùå Pas de connexion internet !');
                return;
            }
            try {
                await docRef.set(JSON.parse(JSON.stringify(data)));
                updateConnectionStatus(true);
                alert('‚úÖ Donn√©es synchronis√©es vers le cloud !');
            } catch(e) {
                alert('‚ùå Erreur de synchronisation: ' + e.message);
            }
        }

        window.addEntry = addEntry;
        window.addExit = addExit;
        window.switchTab = switchTab;
        window.filterHistory = filterHistory;
        window.exportData = exportData;
        window.importData = importData;
        window.handleImport = handleImport;
        window.saveSettings = saveSettings;
        window.syncToFirebase = syncToFirebase;
        window.updateExitEquivalent = updateExitEquivalent;

        loadData();
        updateConnectionStatus(navigator.onLine);
    </script>
</body>
</html>
